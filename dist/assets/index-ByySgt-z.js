import{k as T}from"./kuzu-wasm-BP5yORNQ.js";import"./d3-transition-D-WDeqM-.js";import{z as W}from"./d3-zoom-CTHwvTve.js";import{e as Z,s as b}from"./d3-selection-Dub50jOu.js";import{a as J}from"./d3-drag-Dv6F3X_l.js";import{s as j,l as Q,m as K,c as Y}from"./d3-force-CjnB0ny7.js";import"./d3-dispatch-kxCwF96_.js";import"./d3-timer-DdKHrDhs.js";import"./d3-interpolate-B6xYU604.js";import"./d3-color-9lF95FHy.js";import"./d3-ease-DRPgKoYJ.js";import"./d3-quadtree-CSANTnla.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();const _=(e,a)=>e==="archimate:Junction"?a=="or"?"OrJunction":"AndJunction":e.replace("archimate:",""),ee=e=>[].map.call(e.querySelectorAll('model > folder:not([type="relations"],[type="diagrams"]) element'),n=>({id:n.getAttribute("id"),type:_(n.getAttribute("xsi:type"),n.getAttribute("type")),name:n.getAttribute("name")?n.getAttribute("name"):"",documentation:n.querySelector("documentation")?n.querySelector("documentation").textContent:"",properties:[].map.call(n.querySelectorAll("property"),r=>({name:r.getAttribute("key")??"",value:r.getAttribute("value")??""})).reduce((r,t)=>(r[t.name.toLowerCase()]=t.value,r),{})})),te={1:"Read",2:"Write",3:"ReadWrite"},ne=e=>[].map.call(e.querySelectorAll('folder[type="relations"] element'),n=>({id:n.getAttribute("id"),type:n.getAttribute("xsi:type").replace("archimate:","").replace("Relationship",""),name:n.getAttribute("name")?n.getAttribute("name"):"",documentation:n.querySelector("documentation")?n.querySelector("documentation").textContent:"",source:n.getAttribute("source"),target:n.getAttribute("target"),accessType:te[n.getAttribute("accessType")]??null,properties:[].map.call(n.querySelectorAll("property"),r=>({name:r.getAttribute("key"),value:r.getAttribute("value")})).reduce((r,t)=>(r[t.name.toLowerCase()]=t.value,r),{})})),re=e=>{const a=e.querySelector("model").getAttribute("name"),n=e.querySelector("model > purpose")?e.querySelector("model > purpose").textContent:"",r=ee(e),t=ne(e);return{modelName:a,modelDocumentation:n,nodes:r,links:t}};function oe(e){const a=e.querySelectorAll("model > propertyDefinitions > propertyDefinition");(!a||a.length===0)&&console.warn("No propertyDefinition tags found under <model><propertyDefinitions>");const n=Array.from(a).reduce((r,t)=>{const o=t.getAttribute("identifier"),s=t.querySelector("name"),c=s?s.textContent:"unknown";return r[o]=c,r},{});return console.log("ðŸ”Ž propertyDefinitionsMap:",n),n}function ae(e,a){const n=e.querySelector("model > elements");if(!n)return console.warn("No <elements> container found under <model>."),[];const r=n.querySelectorAll("element");console.log(`ðŸ”Ž Found ${r.length} <element> tags under <model><elements>.`);const t=Array.from(r).filter(o=>{const s=o.getAttribute("xsi:type")||o.getAttribute("type");return!(s!=null&&s.includes("ArchimateDiagramModel"))}).map(o=>{const s=o.getAttribute("identifier")||"no-id",c=o.getAttribute("xsi:type")||o.getAttribute("type")||"Element",i=o.querySelector("name"),l=o.querySelector("documentation"),m={};return o.querySelectorAll("property").forEach(p=>{const y=p.getAttribute("propertyDefinitionRef"),A=a[y]||"unknown",f=p.querySelector("value");m[A.toLowerCase()]=f?f.textContent:""}),{id:s,type:c,name:i?i.textContent:"",documentation:l?l.textContent:"",properties:m}});return console.log("âœ… Parsed Nodes:",t),t}function se(e,a){const n=e.querySelector("model > relationships");if(!n)return console.warn("No <relationships> container found under <model>."),[];const r=n.querySelectorAll("relationship");console.log(`ðŸ”Ž Found ${r.length} <relationship> tags under <model><relationships>.`);const t=Array.from(r).map(o=>{var A,f;const s=o.getAttribute("identifier")||"no-rel-id",c=o.getAttribute("xsi:type")||o.getAttribute("type")||"Relationship",i=o.querySelector("name"),l=o.querySelector("documentation"),m=((A=o.getAttribute("source"))==null?void 0:A.trim())||null,p=((f=o.getAttribute("target"))==null?void 0:f.trim())||null,y={};return o.querySelectorAll("property").forEach(d=>{const u=d.getAttribute("propertyDefinitionRef"),g=a[u]||"unknown",L=d.querySelector("value");y[g.toLowerCase()]=L?L.textContent:""}),{id:s,type:c,name:i?i.textContent:"",documentation:l?l.textContent:"",source:m,target:p,properties:y}});return console.log("âœ… Parsed Links:",t),t}function ie(e){const a=e.querySelector("model");if(!a)return console.warn("No <model> element found in the XML."),{modelName:"Unnamed Model",modelDocumentation:"",nodes:[],links:[]};const n=a.querySelector("name"),r=a.querySelector("documentation"),t=n?n.textContent:"Unnamed Model",o=r?r.textContent:"",s=oe(e),c=ae(e,s),i=se(e,s);return console.log("ðŸŽ¯ Final Graph Data JSON:",{modelName:t,modelDocumentation:o,nodesCount:c.length,linksCount:i.length}),{modelName:t,modelDocumentation:o,nodes:c,links:i}}const v="archiGraphDataStore";let q=null,k=null;const I=(async()=>(await T.init(),q=new T.Database,k=new T.Connection(q),console.log("KÃ¹zu in-memory DB created successfully."),await k.query(`
    CREATE NODE TABLE IF NOT EXISTS Element(
      id STRING PRIMARY KEY,
      layer STRING,
      type STRING,
      name STRING
    );
  `),await k.query(`
    CREATE REL TABLE IF NOT EXISTS Relationship(
      FROM Element TO Element,
      type STRING
    );
  `),console.log("KÃ¹zu 'Element' & 'Relationship' tables ready."),k))();function ce(e){if(e.querySelector('folder[type="elements"]')||e.querySelector('folder[type="relations"]'))return console.log("Detected Archi .archimate file -> Archi parser."),re(e);const a=e.querySelector("model > elements"),n=e.querySelector("model > relationships");if(a&&n)return console.log("Detected ArchiMate Exchange Format -> Exchange parser."),ie(e);throw new Error("Could not detect Archi/Exchange file format from XML.")}async function $(e,a){var n;try{const r=await I;if(!r)throw new Error("KÃ¹zu connection not established.");const t=new DOMParser().parseFromString(e,"text/xml"),o=ce(t);if(!((n=o.nodes)!=null&&n.length))throw new Error("Parsed data is empty or missing relationships.");sessionStorage.setItem(v,JSON.stringify(o)),console.log("Clearing old data from KÃ¹zu..."),await r.query("MATCH (n:Element) DELETE n;"),await r.query("MATCH ()-[r:Relationship]->() DELETE r;"),console.log("Inserting new data into KÃ¹zu...");for(const s of o.nodes){const c=(s.id||"").replace(/'/g,"\\'"),i=(s.type||"").replace(/'/g,"\\'"),l=(s.name||"").replace(/'/g,"\\'");let m="Business";if(s.layer&&s.layer.trim().length>0)m=s.layer;else if(s.type){const y=s.type.toLowerCase();y.includes("business")?m="Business":y.includes("application")?m="Application":y.includes("technology")&&(m="Technology")}const p=`
        CREATE (:Element {
          id: '${c}',
          layer: '${m}',
          type: '${i}',
          name: '${l}'
        });
      `;await r.query(p)}for(const s of o.links){const c=(s.type&&s.type.trim()?s.type:"Unknown").replace(/'/g,"\\'"),i=(s.source||"").replace(/'/g,"\\'"),l=(s.target||"").replace(/'/g,"\\'");if(!i||!l)continue;const m=`
        MATCH (a:Element {id: '${i}'}), (b:Element {id: '${l}'})
        CREATE (a)-[:Relationship {type: '${c}'}]->(b);
      `;await r.query(m)}console.log("Data inserted into KÃ¹zu successfully."),typeof a=="function"&&a()}catch(r){throw console.error("Error processing model file & inserting into KÃ¹zu:",r),r}}async function H(e,a){try{await I;const n=await fetch(e);if(!n.ok)throw new Error(n.statusText);const r=await n.text();await $(r,a)}catch(n){console.error("Error retrieving model file:",n)}}function le(){return!!sessionStorage.getItem(v)}function V(){const e=sessionStorage.getItem(v);return e?JSON.parse(e):{nodes:[],links:[]}}function de(){sessionStorage.removeItem(v)}function ue(){const e=V();return{modelName:e.modelName||"No Model Name",modelDocumentation:e.modelDocumentation||""}}function E(e){return e!=null&&e.length?`[${e.map(n=>`'${n}'`).join(",")}]`:"[]"}async function me(e,a,n){try{const r=await I;if(!r)throw new Error("KÃ¹zu DB not ready.");const t=`
      MATCH (n:Element {id: $rootNodeId})
      MATCH (n)-[r:Relationship]-(m:Element)
      RETURN collect(n) + collect(m) AS nodes, collect(r) AS links;
    `;console.log("Neighborhood Query:",t);const c=(await(await r.query(t,{rootNodeId:e})).getAllObjects())[0]||{nodes:[],links:[]};typeof n=="function"&&n(c)}catch(r){console.error("Error in neighborhood query:",r),alert("Error in neighborhood query: "+r.message)}}async function P(e){try{let d=function(u,g){return typeof g=="bigint"?g.toString():g};const a=await I;if(!a)throw new Error("KÃ¹zu DB not ready.");const n=document.querySelectorAll(".layerCheckbox:checked"),r=n.length?Array.from(n).map(u=>u.value):[],t=r.length?"a.layer IN "+E(r)+" AND b.layer IN "+E(r):"true",o=document.querySelectorAll(".facet-value:not([data-group='relationships']):checked"),s=o.length?Array.from(o).map(u=>u.value):[],c=s.length?"a.type IN "+E(s)+" AND b.type IN "+E(s):"true",i=document.querySelectorAll(".facet-value[data-group='relationships']:checked"),l=i.length?Array.from(i).map(u=>u.value):[],m=l.length?"r.type IN "+E(l):"false",y=`
      MATCH (a:Element)-[r:Relationship]->(b:Element)
      WHERE ${`${t} AND ${c} AND ${m}`}
      RETURN a, r, b
      LIMIT 1000
    `;console.log("Global Filter Query:",y);const A=await a.query(y),f=await pe(A);sessionStorage.setItem(v,JSON.stringify(f,d)),typeof e=="function"&&e(f)}catch(a){console.error("Error in global filtering:",a),alert("Error in global filtering: "+a.message)}}async function pe(e){if(!e||typeof e.getAllObjects!="function")return console.error("buildSubgraphFromRecords: queryResult.getAllObjects is not defined"),{nodes:[],links:[]};let a=await e.getAllObjects();(!a||!Array.isArray(a))&&(console.error("buildSubgraphFromRecords: rows is not an array",a),a=[]);const n=new Map,r=[];return a.forEach(t=>{const o=t.a||t.A,s=t.b||t.B,c=t.r||t.R;o&&o.id&&n.set(o.id,o),s&&s.id&&n.set(s.id,s),o&&s&&c&&c.type&&r.push({source:o.id,target:s.id,type:c.type})}),{nodes:Array.from(n.values()),links:r}}const F="/data/ArchiSurance.archimate",ge={"Confidential (Red)":"#f00","Restricted (Amber)":"#ff8000","Limited Disclosure (Green)":"#00a400","Unlimited Disclosure (White)":"#fff"},z=e=>{switch(e){case"ApplicationComponent":case"ApplicationCollaboration":case"ApplicationEvent":case"ApplicationFunction":case"ApplicationInteraction":case"ApplicationInterface":case"ApplicationProcess":case"ApplicationService":case"DataObject":return"#b6f4f6";case"BusinessActor":case"BusinessCollaboration":case"BusinessEvent":case"BusinessFunction":case"BusinessInteraction":case"BusinessInterface":case"BusinessObject":case"BusinessProcess":case"BusinessRole":case"BusinessService":case"Contract":case"Product":case"Representation":case"Location":return"#ffffb1";case"Assessment":case"Constraint":case"Driver":case"Goal":case"Meaning":case"Outcome":case"Principle":case"Requirement":case"Stakeholder":case"Value":return"#ccf";case"DistributionNetwork":case"Equipment":case"Facility":case"Material":return"#d1f6c5";case"Artifact":case"CommunicationNetwork":case"Device":case"Node":case"Path":case"SystemSoftware":case"TechnologyCollaboration":case"TechnologyEvent":case"TechnologyFunction":case"TechnologyInteraction":case"TechnologyInterface":case"TechnologyProcess":case"TechnologyService":return"#d1f6c5";case"Capability":case"CourseOfAction":case"Resource":case"ValueStream":return"#f5deaa";case"Deliverable":case"Gap":case"ImplementationEvent":case"Plateau":case"WorkPackage":return"#ffe0e0"}return"#fefefe"},ye=e=>{switch(e){case"ApplicationComponent":return"m -5 1 l 4 0 l 0 2 l -4 0 z m 0 -4 l 4 0 l 0 2 l -4 0 z m 2 0 l 0 -2 l 8 0 l 0 10 l -8 0 l 0 -2 m 0 -2 l 0 -2";case"Artifact":return"M 4 -1 V 5 H -4 V -5 H 0 L 3.35 -1.5 H 0 V -5";case"Assessment":return"m -3.5 -2 C -3.5 -8 5.5 -8 5.5 -2 C 5.5 4 -3.5 4 -3.5 -2 M -1 2 L -4 7";case"ApplicationCollaboration":case"BusinessCollaboration":case"TechnologyCollaboration":return"m -7 0 A 1 1 0 0 0 2 0 A 1 1 0 0 0 -7 0 M -2 0 A 1 1 0 0 0 7 0 A 1 1 0 0 0 -2 0";case"ApplicationEvent":case"BusinessEvent":case"TechnologyEvent":case"ImplementationEvent":return"m -5 -4 C -2 -3 -2 3 -5 4 H 3 C 6 3 6 -3 3 -4 H -5 M 3 -4";case"ApplicationFunction":case"BusinessFunction":case"TechnologyFunction":return"M -0.35 -5.2 L 4 -1 L 4 5 L 0 2 L -4 5 L -4 -1 L 0.35 -5.2";case"ApplicationInteraction":case"BusinessInteraction":case"TechnologyInteraction":return"m -1 -5 C -6 -4 -6 4 -1 5 Z M 1 -5 V -5 C 6 -4 6 4 1 5 Z";case"ApplicationInterface":case"BusinessInterface":case"TechnologyInterface":return"m -3 0 z c 0 -6 9 -6 9 0 C 6 6 -3 6 -3 0 H -8 z";case"ApplicationProcess":case"BusinessProcess":case"TechnologyProcess":return"m -5 -1.5 H 2 V -4 L 6 0 L 2 4 V 1.5 H -5 z";case"ApplicationService":case"BusinessService":case"TechnologyService":return"m -4 3 z c -4 0 -4 -6 0 -6 H 4 C 8 -3 8 3 4 3 z";case"BusinessActor":return"m 0 -2 A 1 1 0 0 0 0 -6 A 1 1 0 0 0 0 -2 V 3 M -3 6 L 0 3 M 3 6 L 0 3 M -3 0 H 3";case"BusinessRole":case"Stakeholder":return"m -4 -3 C -6 -3 -6 3 -4 3 H 4 C 6 3 6 -3 4 -3 H -4 M 4 -3 c -2 0 -2 6 0 6";case"BusinessObject":case"DataObject":return"m -5 -5 H 5 V 5 V 5 V 5 H -5 Z M -5 -3 H 5";case"Capability":return"m -4.5 4.5 h 9 v -9 h -3 v 9 m 3 -6 h -6 v 6 m 6 -3 h -9 v 3";case"CommunicationNetwork":return"m -4 -3 A 1 1 0 0 0 -1 -3 m 0 0 A 1 1 0 0 0 -4 -3 m 6 0 A 1 1 0 0 0 5 -3 A 1 1 0 0 0 2 -3 H -1 m -4 6 A 1 1 0 0 0 -2 3 A 1 1 0 0 0 -5 3 m 6 0 A 1 1 0 0 0 4 3 A 1 1 0 0 0 1 3 H -2 M -2.5 -1.5 L -3.5 1.5 M 3.5 -1.5 L 2.5 1.5";case"Constraint":return"m -4 -4 H 6 L 4 4 H -6 L -4 -4 M -3 4 L -1 -4";case"Contract":return"m -5 -5 H 5 V 5 V 5 V 5 H -5 Z M -5 -3 H 5 M -5 3 H 5";case"CourseOfAction":return"M -4 -1 A 1 1 0 0 0 6 -1 M 6 -1 A 1 1 0 0 0 -4 -1 M -2 -1 A 1 1 0 0 0 4 -1 A 1 1 0 0 0 -2 -1 M 0 -1 A 1 1 0 0 0 2 -1 A 1 1 0 0 0 0 -1 m 0.5 0 a 0.5 0.5 0 0 0 1 0 a 0.5 0.5 0 0 0 -1 0 m 0.5 0 m -6 3 L -2.5 2.5 L -3 5 Z M -6 5 Q -6 3 -4 3 L -3.5 4 Q -5 4 -5 6 Z";case"Deliverable":return"M -5 2 V -3.5 H 5 V 2 Q 2.5 0 0 2 Q -2.5 4 -5 2 Z";case"Device":return"M -3 2 L -5 5 H 5 L 3 2 H 4 C 5 2 5 2 5 1 V -4 C 5 -5 5 -5 4 -5 h -8 C -5 -5 -5 -5 -5 -4 V 1 C -5 2 -5 2 -4 2 H -3 H 3";case"Driver":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -3 0 A 1 1 0 0 0 3 0 A 1 1 0 0 0 -3 0 M -1 0 A 1 1 0 0 0 1 0 A 1 1 0 0 0 -1 0 M -0.5 0 A 0.5 -0.5 0 0 0 0.5 0 A 0.5 0.5 0 0 0 -0.5 0";case"Gap":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -6.3 1.5 H 6.3 M -6.3 -1.5 H 6.3";case"Goal":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -3 0 A 1 1 0 0 0 3 0 A 1 1 0 0 0 -3 0 M -1 0 A 1 1 0 0 0 1 0 A 1 1 0 0 0 -1 0";case"Location":return"m 4 -1 C 6 -8 -6 -8 -4 -1 L 0 6 Z";case"Meaning":return"M -5 0 C -7 -1 -3 -5 -2 -3 C 0 -5 3 -4 2 -2 C 4 -3 6 -2 5 0 C 7 1 5 4 2 3 C 3 5 -3 5 -3 3 C -5 4 -6 2 -5 0 Z";case"Node":return"m -5 -3 V 5 h 8 v -8.5 h -7.32 l 2 -2 H 5 V 2 L 3.1 5.23 M 3 -3 L 5 -5";case"Outcome":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -3 0 A 1 1 0 0 0 3 0 A 1 1 0 0 0 -3 0 M -1 0 A 1 1 0 0 0 1 0 A 1 1 0 0 0 -1 0 M -0.5 0 A 0.5 -0.5 0 0 0 0.5 0 A 0.5 0.5 0 0 0 -0.5 0 M 0 0 L 5.7 -5.7 M 4.5 -7 L 4.2 -4.2 L 7 -4.5";case"Path":return"m -3 4 L -6 0 L -3 -4 M 3 -4 L 6 0 L 3 4 M -3.2 -0.2 H -2.8 V 0.2 H -3.2 Z M -0.2 -0.2 H 0.2 V 0.2 H -0.2 Z M 2.8 -0.2 H 3.2 V 0.2 H 2.8 Z";case"Plateau":return"M -5 0 H 5 M -6 2.4 H 4 M -4 -2.4 H 6";case"Principle":return"M -5 -5 Q -5 -6 -4 -6 Q 0 -6 4 -6 Q 5 -6 5 -5 V 5 Q 5 6 4 6 H -4 Q -5 6 -5 5 Z M -0.35 1.5 V -4 H 0.35 V 1.5 Z M -0.35 3.35 V 4 H 0.35 V 3.35 Z";case"Product":return"m -5 -5 H 5 V 5 V 5 V 5 H -5 Z M -5 -3 H 0 V -5";case"Representation":return"m -5 -5 H 5 v 9 v 0 v 0 c -5 -3 -5 3 -10 0 Z M -5 -3 H 5";case"Requirement":return"m -4 -4 H 6 L 4 4 H -6 Z";case"Resource":return"M -6 -3 Q -6 -4 -5 -4 H 4 Q 5 -4 5 -3 V 3 Q 5 4 4 4 H -5 Q -6 4 -6 3 z m 11 5 A 1 1 0 0 0 6 1 V -1 A 1 1 0 0 0 5 -2 Z M -4 -2 H -4 V 2 M -2 -2 V 2 M 0 -2 V 2";case"SystemSoftware":return"m -6 1 Z c 0 -7 10 -7 10 0 c 0 7 -10 7 -10 0 z m 1 -3.3 c 4 -8.7 15 -1.7 8 6.6";case"Value":return"m -6 0 C -6 -6 6 -6 6 0 C 6 6 -6 6 -6 0";case"ValueStream":return"M 6 0 L 3 4 H -5 L -2 0 L -5 -4 H 3 Z";case"WorkPackage":return"M 3 2 V 0.5 L 5.2 2 L 3 3.5 V 2 H 3.4 V 1.4 L 4.2 2 L 3.4 2.6 V 2 M 3 2 H -2 A 3.4 3.4 0 1 1 0.4 1";case"AndJunction":case"OrJunction":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0"}return""},fe=(e,a,n,r,t)=>{const s=n.append("g").attr("id","nodes").selectAll("g").data(r).enter().append("g").attr("id",i=>i.id).attr("class",i=>"element-"+i.type.toLowerCase()).classed("node-root",i=>!1);return s.append("circle").attr("r",10).attr("fill",i=>i.properties!==void 0&&i.properties.dataclassificationlevel!==void 0?ge[i.properties.dataclassificationlevel]:z(i.type)).append("title").text(i=>{let l=i.name;return i.documentation!==void 0&&i.documentation.length>0&&(l+=" - "+i.documentation),l}),s.append("path").attr("d",i=>ye(i.type)).attr("class","node-icon"),s.append("text").attr("class","node-label-type").attr("dx",i=>16).attr("dy",i=>-2).text(i=>{let l="("+i.type+")";return i.properties!==void 0&&i.properties.stereotype!==void 0&&(l+=" Â«"+i.properties.stereotype+"Â»"),l}),s.append("text").attr("class","node-label-name").attr("dx",i=>16).attr("dy",i=>8).text(i=>i.name),s},he={colorForNodeType:z},O=e=>{const a=e.append("defs"),n=10,r=10;a.append("marker").attr("id","relationship-arrow-open").attr("viewBox",[0,-8,20,20]).attr("refX",31).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",n).attr("markerHeight",r).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("class","relationship-arrow-open"),a.append("marker").attr("id","relationship-arrow-open-read").attr("viewBox",[0,-8,20,20]).attr("refX",-21).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",n).attr("markerHeight",r).attr("orient","auto").append("path").attr("d","M10,-5L0,0L10,5").attr("class","relationship-arrow-open"),a.append("marker").attr("id","relationship-arrow-closed").attr("viewBox",[0,-8,20,20]).attr("refX",31).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",n).attr("markerHeight",r).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("class","relationship-arrow-closed"),a.append("marker").attr("id","relationship-arrowlarge-open").attr("viewBox",[0,-8,20,20]).attr("refX",31).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",n).attr("markerHeight",r).attr("orient","auto").append("path").attr("d","M 0 0 L 0 -8 L 10 0 L 0 8 L 0 0").attr("class","relationship-arrowlarge-open"),a.append("marker").attr("id","relationship-diamond-open-start").attr("viewBox",[0,-8,22,22]).attr("refX",-23).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",n).attr("markerHeight",r).attr("orient","auto").append("path").attr("d","M 0 0 L 8 -6 L 16 0 L 8 6 L 0 0").attr("class","relationship-diamond-open"),a.append("marker").attr("id","relationship-diamond-closed-start").attr("viewBox",[0,-8,22,22]).attr("refX",-23).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",n).attr("markerHeight",r).attr("orient","auto").append("path").attr("d","M 0 0 L 8 -6 L 16 0 L 8 6 L 0 0").attr("class","relationship-diamond-closed"),a.append("marker").attr("id","relationship-circle-closed-start").attr("viewBox",[0,-8,22,22]).attr("refX",-23).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",n).attr("markerHeight",r).attr("orient","auto").append("path").attr("d","M 5, 0 m -5, 0 a 5,5 0 1,0 10,0 a 5,5 0 1,0 -10,0").attr("class","relationship-circle-closed")},Ae=(e,a)=>{const n=e.append("g").attr("id","links").selectAll("line").data(a).enter().append("line").attr("id",r=>r.id).attr("class",r=>"relationship-"+r.type.toLowerCase()).attr("marker-start",r=>we(r)).attr("marker-end",r=>Le(r)).attr("stroke","#666").attr("stroke-width",1);return n.append("title").text(r=>r.name),n},we=e=>{switch(e.type){case"Access":return e.accessType==="Read"||e.accessType==="ReadWrite"?"url(#relationship-arrow-open-read)":null;case"Aggregation":return"url(#relationship-diamond-open-start)";case"Composition":return"url(#relationship-diamond-closed-start)";case"Assignment":return"url(#relationship-circle-closed-start)"}},Le=e=>{switch(e.type){case"Triggering":case"Assignment":case"Flow":return"url(#relationship-arrow-closed)";case"Influence":case"Serving":return"url(#relationship-arrow-open)";case"Access":return e.accessType==="Write"||e.accessType==="ReadWrite"?"url(#relationship-arrow-open)":null;case"Realization":case"Specialization":return"url(#relationship-arrowlarge-open)"}};function h(e){return typeof e=="object"&&e.id?e.id:e}function Ee(e,a,n,r){const t=a.filter(s=>{const c=h(s.source),i=h(s.target);return e.find(l=>l.id===c)&&e.find(l=>l.id===i)}),o=j(e).force("link",Q(t).id(s=>s.id).distance(100).strength(1)).force("charge",K().strength(-300)).force("center",Y(n/2,r/2));o.tick(300),o.stop()}function U(e,a,n,r,t){Z("#graph-viewer").remove();const o=r.clientWidth,s=r.clientHeight,c=b(r).append("svg").attr("id","graph-viewer").attr("width",o).attr("height",s);Ee(e,n,o,s),typeof O=="function"&&O(c);const i=c.append("g").attr("id","viewer"),l=n.filter(d=>e.find(u=>u.id===h(d.source))&&e.find(u=>u.id===h(d.target))),m=Ae(i,l);function p(d,u,g="x"){const L=typeof d=="object"&&d.id?d.id:d,B=u.find(X=>X.id===L);return B?g==="x"?B.x:B.y:0}m.attr("x1",d=>p(d.source,e,"x")).attr("y1",d=>p(d.source,e,"y")).attr("x2",d=>p(d.target,e,"x")).attr("y2",d=>p(d.target,e,"y"));const y=fe(o,s,i,e).attr("transform",d=>`translate(${d.x}, ${d.y})`);y.on("dblclick",function(d,u){d.stopPropagation();const g=parseInt(document.getElementById("depthSlider").value,10);document.getElementById("loading-message").style.display="block",me(u.id,g,L=>{document.getElementById("loading-message").style.display="none",U(L.nodes,null,L.links,r)})});const A=J().on("start",function(d,u){b(this).classed("dragging-node",!0)}).on("drag",function(d,u){u.x=d.x,u.y=d.y,b(this).attr("transform",`translate(${u.x}, ${u.y})`),m.filter(g=>h(g.source)===u.id||h(g.target)===u.id).attr("x1",g=>p(h(g.source),e,"x")).attr("y1",g=>p(h(g.source),e,"y")).attr("x2",g=>p(h(g.target),e,"x")).attr("y2",g=>p(h(g.target),e,"y"))}).on("end",function(d,u){b(this).classed("dragging-node",!1)});y.call(A);const f=W().on("zoom",d=>{i.attr("transform",d.transform)});c.call(f).on("dblclick.zoom",null),c.insert("rect",":first-child").attr("id","canvas-bg").attr("width",o).attr("height",s).attr("fill","transparent").on("click",()=>{y.selectAll("*").classed("highlighted",!1).classed("neighbor-highlight",!1),m.classed("link-highlight",!1)}),Se(e,c)}function Se(e,a){if(!e.length){a.attr("viewBox",`0 0 ${window.innerWidth} ${window.innerHeight}`);return}let n=1/0,r=1/0,t=-1/0,o=-1/0;e.forEach(c=>{c.x<n&&(n=c.x),c.y<r&&(r=c.y),c.x>t&&(t=c.x),c.y>o&&(o=c.y)});const s=20;a.attr("viewBox",`${n-s} ${r-s} ${t-n+2*s} ${o-r+2*s}`)}const D="archiGraphUserSettings";let N={userLoadedModel:!1,userLoadedModelFilename:"",stickyNodesOnDrag_Enabled:!0};const Me=e=>{localStorage.setItem(D,JSON.stringify(e))},C=()=>{let e=N;return localStorage.getItem(D)&&(e=JSON.parse(localStorage.getItem(D))),e},R=e=>{let a=C();return!(e in a)&&e in N&&(w(e,N[e]),a=C()),a[e]},w=(e,a)=>{let n=C();n[e]=a,Me(n)},ve=()=>{const e=C();if(e.userLoadedModel){const a=document.getElementById("userModelLoad-dragDrop-message");a.innerText=`Current loaded model: ${e.userLoadedModelFilename}`,document.getElementById("userModelLoad-delete").classList.remove("hidden")}document.getElementById("stickyNodesOnDrag").checked=R("stickyNodesOnDrag_Enabled"),document.getElementById("dialog-userSettings").showModal()},G=()=>{document.getElementById("dialog-userSettings").close(),document.getElementById("userModelLoad-dragDrop-message").innerText=""},be=(e,a)=>{var s;const n=((s=e.dataTransfer)==null?void 0:s.files)||e.target.files;if(!n||n.length===0){alert("No files were detected. Please try again.");return}const r=n[0];if(![".xml",".archimate"].some(c=>r.name.endsWith(c))){alert("Oops, it must be an .xml or .archimate file! Please ensure it is an ArchiMate Exchange Format or Archi file.");return}const t=document.getElementById("userModelLoad-dragDrop-message");t.innerText=`Loading: ${r.name}`;const o=new FileReader;o.onload=()=>{$(o.result,()=>{w("userLoadedModel",!0),w("userLoadedModelFilename",r.name),document.getElementById("userModelLoad-delete").classList.remove("hidden"),t.innerText=`The ${r.name} file has been loaded.`,typeof a=="function"&&a()})},o.readAsText(r)},ke=()=>{const e=R("userLoadedModelFilename");de();const a=document.getElementById("userModelLoad-dragDrop-message");a.innerText=`${e} has been deleted, the default model has been loaded`,w("userLoadedModel",!1),w("userLoadedModelFilename",""),document.getElementById("userModelLoad-delete").classList.add("hidden")},{colorForNodeType:Ce}=he;function S(e){return e.replace(/[<>&'"]/g,function(a){switch(a){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}})}function Ie(e,a){const n={Capability:1,CourseOfAction:1,Resource:1,ValueStream:1,BusinessActor:2,BusinessCollaboration:2,BusinessEvent:2,BusinessFunction:2,BusinessInteraction:2,BusinessInterface:2,BusinessObject:2,BusinessProcess:2,BusinessRole:2,BusinessService:2,Contract:2,Product:2,Representation:2,ApplicationComponent:3,ApplicationCollaboration:3,ApplicationEvent:3,ApplicationFunction:3,ApplicationInteraction:3,ApplicationInterface:3,ApplicationProcess:3,ApplicationService:3,DataObject:3,Artifact:4,CommunicationNetwork:4,Device:4,Node:4,Path:4,SystemSoftware:4,TechnologyCollaboration:4,TechnologyEvent:4,TechnologyFunction:4,TechnologyInteraction:4,TechnologyInterface:4,TechnologyProcess:4,TechnologyService:4,"Distribution Network":5,Equipment:5,Facility:5,Material:5},r={};e.forEach(o=>{r[o.id]=o.type});let t=`<?xml version="1.0" encoding="utf-8"?>
`;return t+=`<graphml xmlns="http://graphml.graphdrawing.org/xmlns"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:y="http://www.yworks.com/xml/graphml"
    xsi:schemaLocation="http://graphml.graphdrawing.org/xmlns
      http://www.yworks.com/xml/schema/graphml/1.0/ygraphml.xsd">
`,t+=`  <key for="node" id="d0" yfiles.type="nodegraphics"/>
`,t+=`  <key attr.name="description" attr.type="string" for="node" id="d1"/>
`,t+=`  <key for="edge" id="d2" yfiles.type="edgegraphics"/>
`,t+=`  <key attr.name="description" attr.type="string" for="edge" id="d3"/>
`,t+=`  <graph id="G" edgedefault="directed">
`,e.forEach(o=>{const s=S(o.id),c=(o.name||"")+(o.type?` (${o.type})`:""),i=Ce(o.type),l=o.x!==void 0?parseFloat(o.x):0,m=o.y!==void 0?parseFloat(o.y):0,p=100,y=40;t+=`    <node id="${s}">
`,t+=`      <data key="d0">
`,t+=`        <y:ShapeNode>
`,t+=`          <y:Geometry x="${l}" y="${m}" width="${p}" height="${y}"/>
`,t+=`          <y:Fill color="${i}" transparent="false"/>
`,t+=`          <y:BorderStyle color="#000000" type="line" width="1.0"/>
`,t+=`          <y:NodeLabel alignment="center" autoSizePolicy="node_width" fontFamily="Dialog" fontSize="5" fontStyle="plain" textColor="#000000" visible="true" modelName="internal" modelPosition="c">
`,t+=`            ${S(c)}
`,t+=`          </y:NodeLabel>
`,t+=`          <y:Shape type="rectangle"/>
`,t+=`        </y:ShapeNode>
`,t+=`      </data>
`,t+=`    </node>
`}),a.forEach((o,s)=>{let c=typeof o.source=="object"?o.source.id:o.source,i=typeof o.target=="object"?o.target.id:o.target;const l=r[c],m=r[i];n[l]&&n[m]?n[l]>n[m]&&([c,i]=[i,c]):(o.type==="Realization"||o.type==="Serving")&&([c,i]=[i,c]);const p=`e${s}`;t+=`    <edge id="${S(p)}" source="${S(c)}" target="${S(i)}">
`,t+=`      <data key="d2">
`,t+=`        <y:PolyLineEdge>
`,t+=`          <y:LineStyle color="#000000" type="line" width="1.0"/>
`,t+=`          <y:Arrows source="none" target="standard"/>
`,t+=`          <y:BendStyle smoothed="true"/>
`,t+=`        </y:PolyLineEdge>
`,t+=`      </data>
`,t+=`    </edge>
`}),t+=`  </graph>
`,t+=`</graphml>
`,t}function xe(e,a){const n=new Blob([e],{type:"application/xml"}),r=URL.createObjectURL(n),t=document.createElement("a");t.href=r,t.download=a,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(r)}function Be(){const e=sessionStorage.getItem("archiGraphDataStore");if(!e){alert("No graph data found in session storage.");return}const a=JSON.parse(e);let n=Array.isArray(a.nodes)?a.nodes:Object.values(a.nodes||{});const r=a.links||[],t={};n.forEach(c=>{t[c.id]=c}),r.forEach(c=>{const i=typeof c.source=="object"?c.source.id:c.source,l=typeof c.target=="object"?c.target.id:c.target;t[i]||(t[i]={id:i,name:i,type:"Undefined",x:0,y:0}),t[l]||(t[l]={id:l,name:l,type:"Undefined",x:0,y:0})}),n=Object.values(t);const o=Ie(n,r),s=(a.modelName||"graph")+".graphml";xe(o,s)}typeof document<"u"&&document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("exportGraphMLButton");e&&e.addEventListener("click",Be)});function Te(){const e=document.getElementById("applyFiltersBtn");e&&e.addEventListener("click",()=>{P(a=>{const n=new Event("kuzuFiltersDone");document.dispatchEvent(n)})})}let De=typeof window<"u"?new URLSearchParams(window.location.search):new URLSearchParams;function x(){const e=V();document.getElementById("loading-message").style.display="none",console.log("Nodes:",e.nodes),console.log("Links:",e.links),U(e.nodes,null,e.links,document.getElementById("graph-container"))}function M(){x()}function Ne(){De.get("showheader"),document.querySelector("header").style.display="block",document.getElementById("action-userSettings").classList.remove("hidden"),document.getElementById("userSettings-userModelLoad").classList.remove("hidden")}function He(e,a){let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),a)}}document.getElementById("action-reload").addEventListener("click",()=>{H(F,M)});document.getElementById("action-model-overview").addEventListener("click",()=>{const e=ue();document.getElementById("model-name").innerText=e.modelName,document.getElementById("model-documentation").innerText=e.modelDocumentation,document.getElementById("dialog-overview").showModal()});document.getElementById("dialog-overview-close").addEventListener("click",()=>{document.getElementById("dialog-overview").close()});document.getElementById("dialog-overview-close-x").addEventListener("click",()=>{document.getElementById("dialog-overview").close()});document.getElementById("action-userSettings").addEventListener("click",()=>{ve()});document.getElementById("dialog-userSettings-close").addEventListener("click",()=>{G()});document.getElementById("dialog-userSettings-close-x").addEventListener("click",()=>{G()});document.getElementById("userModelLoad-dragDrop-zone").addEventListener("dragover",e=>{e.preventDefault()});document.getElementById("userModelLoad-dragDrop-zone").addEventListener("drop",e=>{e.preventDefault(),be(e,M)});document.getElementById("userModelLoad-delete").addEventListener("click",()=>{ke(),H(F,M)});document.getElementById("stickyNodesOnDrag").addEventListener("change",function(){w("stickyNodesOnDrag_Enabled",this.checked)});Te();document.getElementById("applyFiltersBtn").addEventListener("click",async()=>{document.getElementById("loading-message").style.display="block",await P(e=>{document.getElementById("loading-message").style.display="none";const a=new Event("kuzuFiltersDone");document.dispatchEvent(a)})});window.onload=async()=>{Ne(),le()||(w("userLoadedModel",!1),w("userLoadedModelFilename","")),R("userLoadedModel")?M():await H(F,M)};window.onresize=He(()=>{x()},100);window.onpopstate=()=>{x()};document.addEventListener("kuzuFiltersDone",()=>{console.log("Global filter applied => re-draw from session"),x()});
