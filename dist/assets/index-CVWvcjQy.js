import{k as N}from"./kuzu-wasm-BP5yORNQ.js";import"./d3-transition-D-WDeqM-.js";import{z as W}from"./d3-zoom-CTHwvTve.js";import{e as Q,s as k}from"./d3-selection-Dub50jOu.js";import{a as K}from"./d3-drag-Dv6F3X_l.js";import{s as Y,l as _,m as ee,c as te}from"./d3-force-CjnB0ny7.js";import"./d3-dispatch-kxCwF96_.js";import"./d3-timer-DdKHrDhs.js";import"./d3-interpolate-B6xYU604.js";import"./d3-color-9lF95FHy.js";import"./d3-ease-DRPgKoYJ.js";import"./d3-quadtree-CSANTnla.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function o(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?r.credentials="include":t.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(t){if(t.ep)return;t.ep=!0;const r=o(t);fetch(t.href,r)}})();const ne=(e,n)=>e==="archimate:Junction"?n=="or"?"OrJunction":"AndJunction":e.replace("archimate:",""),re=e=>[].map.call(e.querySelectorAll('model > folder:not([type="relations"],[type="diagrams"]) element'),o=>({id:o.getAttribute("id"),type:ne(o.getAttribute("xsi:type"),o.getAttribute("type")),name:o.getAttribute("name")?o.getAttribute("name"):"",documentation:o.querySelector("documentation")?o.querySelector("documentation").textContent:"",properties:[].map.call(o.querySelectorAll("property"),a=>({name:a.getAttribute("key")??"",value:a.getAttribute("value")??""})).reduce((a,t)=>(a[t.name.toLowerCase()]=t.value,a),{})})),oe={1:"Read",2:"Write",3:"ReadWrite"},ae=e=>[].map.call(e.querySelectorAll('folder[type="relations"] element'),o=>({id:o.getAttribute("id"),type:o.getAttribute("xsi:type").replace("archimate:","").replace("Relationship",""),name:o.getAttribute("name")?o.getAttribute("name"):"",documentation:o.querySelector("documentation")?o.querySelector("documentation").textContent:"",source:o.getAttribute("source"),target:o.getAttribute("target"),accessType:oe[o.getAttribute("accessType")]??null,properties:[].map.call(o.querySelectorAll("property"),a=>({name:a.getAttribute("key"),value:a.getAttribute("value")})).reduce((a,t)=>(a[t.name.toLowerCase()]=t.value,a),{})})),se=e=>{const n=e.querySelector("model").getAttribute("name"),o=e.querySelector("model > purpose")?e.querySelector("model > purpose").textContent:"",a=re(e),t=ae(e);return{modelName:n,modelDocumentation:o,nodes:a,links:t}};function ie(e){const n=e.querySelectorAll("model > propertyDefinitions > propertyDefinition");(!n||n.length===0)&&console.warn("No propertyDefinition tags found under <model><propertyDefinitions>");const o=Array.from(n).reduce((a,t)=>{const r=t.getAttribute("identifier"),i=t.querySelector("name"),c=i?i.textContent:"unknown";return a[r]=c,a},{});return console.log("ðŸ”Ž propertyDefinitionsMap:",o),o}function ce(e,n){const o=e.querySelector("model > elements");if(!o)return console.warn("No <elements> container found under <model>."),[];const a=o.querySelectorAll("element");console.log(`ðŸ”Ž Found ${a.length} <element> tags under <model><elements>.`);const t=Array.from(a).filter(r=>{const i=r.getAttribute("xsi:type")||r.getAttribute("type");return!(i!=null&&i.includes("ArchimateDiagramModel"))}).map(r=>{const i=r.getAttribute("identifier")||"no-id",c=r.getAttribute("xsi:type")||r.getAttribute("type")||"Element",s=r.querySelector("name"),d=r.querySelector("documentation"),y={};return r.querySelectorAll("property").forEach(m=>{const f=m.getAttribute("propertyDefinitionRef"),A=n[f]||"unknown",l=m.querySelector("value");y[A.toLowerCase()]=l?l.textContent:""}),{id:i,type:c,name:s?s.textContent:"",documentation:d?d.textContent:"",properties:y}});return console.log("âœ… Parsed Nodes:",t),t}function le(e,n){const o=e.querySelector("model > relationships");if(!o)return console.warn("No <relationships> container found under <model>."),[];const a=o.querySelectorAll("relationship");console.log(`ðŸ”Ž Found ${a.length} <relationship> tags under <model><relationships>.`);const t=Array.from(a).map(r=>{var A,l;const i=r.getAttribute("identifier")||"no-rel-id",c=r.getAttribute("xsi:type")||r.getAttribute("type")||"Relationship",s=r.querySelector("name"),d=r.querySelector("documentation"),y=((A=r.getAttribute("source"))==null?void 0:A.trim())||null,m=((l=r.getAttribute("target"))==null?void 0:l.trim())||null,f={};return r.querySelectorAll("property").forEach(p=>{const u=p.getAttribute("propertyDefinitionRef"),g=n[u]||"unknown",h=p.querySelector("value");f[g.toLowerCase()]=h?h.textContent:""}),{id:i,type:c,name:s?s.textContent:"",documentation:d?d.textContent:"",source:y,target:m,properties:f}});return console.log("âœ… Parsed Links:",t),t}function de(e){const n=e.querySelector("model");if(!n)return console.warn("No <model> element found in the XML."),{modelName:"Unnamed Model",modelDocumentation:"",nodes:[],links:[]};const o=n.querySelector("name"),a=n.querySelector("documentation"),t=o?o.textContent:"Unnamed Model",r=a?a.textContent:"",i=ie(e),c=ce(e,i),s=le(e,i);return console.log("ðŸŽ¯ Final Graph Data JSON:",{modelName:t,modelDocumentation:r,nodesCount:c.length,linksCount:s.length}),{modelName:t,modelDocumentation:r,nodes:c,links:s}}let T={layers:["Business","Application","Technology"],elementTypes:[],relationshipTypes:[]};const z=[];function R(){return JSON.parse(JSON.stringify(T))}function ue(e){T={...T,...e},console.log("Facet state updated:",T),z.forEach(n=>n(R()))}function pe(e){z.push(e)}const b="archiGraphDataStore";let V=null,C=null;const B=(async()=>(await N.init(),V=new N.Database,C=new N.Connection(V),console.log("KÃ¹zu inâ€‘memory DB created successfully."),await C.query(`
    CREATE NODE TABLE IF NOT EXISTS Element(
      id    STRING PRIMARY KEY,
      layer STRING,
      type  STRING,
      name  STRING
    );
  `),await C.query(`
    CREATE REL TABLE IF NOT EXISTS Relationship(
      FROM Element TO Element,
      type STRING
    );
  `),console.log("KÃ¹zu 'Element' & 'Relationship' tables ready."),C))();function me(e){if(e.querySelector('folder[type="elements"]')||e.querySelector('folder[type="relations"]'))return console.log("Detected Archi .archimate file â†’ Archi parser."),se(e);const n=e.querySelector("model > elements"),o=e.querySelector("model > relationships");if(n&&o)return console.log("Detected ArchiMate Exchange Format â†’ Exchange parser."),de(e);throw new Error("Could not detect Archi/Exchange file format from XML.")}function S(e){return e!=null&&e.length?`[${e.map(n=>`'${n}'`).join(",")}]`:"[]"}async function U(e,n){var o,a,t;try{const r=await B;if(!r)throw new Error("KÃ¹zu connection not established.");const i=new DOMParser().parseFromString(e,"text/xml"),c=me(i);if(!((o=c.nodes)!=null&&o.length))throw new Error("Parsed data is empty or missing relationships.");sessionStorage.setItem(b,JSON.stringify(c)),await r.query("MATCH (n:Element) DELETE n;"),await r.query("MATCH ()-[r:Relationship]->() DELETE r;");for(const s of c.nodes){const d=(s.id||"").replace(/'/g,"\\'"),y=(s.type||"").replace(/'/g,"\\'"),m=(s.name||"").replace(/'/g,"\\'");let f="Business";if((a=s.layer)!=null&&a.trim())f=s.layer;else if(s.type){const A=s.type.toLowerCase();A.includes("application")?f="Application":A.includes("technology")&&(f="Technology")}await r.query(`
        CREATE (:Element { id: '${d}', layer: '${f}', type: '${y}', name: '${m}' });
      `)}for(const s of c.links){const d=(s.source||"").replace(/'/g,"\\'"),y=(s.target||"").replace(/'/g,"\\'");if(!d||!y)continue;const m=(((t=s.type)==null?void 0:t.trim())||"Unknown").replace(/'/g,"\\'");await r.query(`
        MATCH (a:Element {id: '${d}'}), (b:Element {id: '${y}'})
        CREATE (a)-[:Relationship {type: '${m}'}]->(b);
      `)}console.log("Data inserted into KÃ¹zu successfully."),typeof n=="function"&&n()}catch(r){throw console.error("Error processing model file & inserting into KÃ¹zu:",r),r}}async function O(e,n){try{await B;const o=await fetch(e);if(!o.ok)throw new Error(o.statusText);await U(await o.text(),n)}catch(o){console.error("Error retrieving model file:",o)}}function ge(){return!!sessionStorage.getItem(b)}function G(){const e=sessionStorage.getItem(b);return e?JSON.parse(e):{nodes:[],links:[]}}function ye(){sessionStorage.removeItem(b)}function fe(){const e=G();return{modelName:e.modelName||"No Model Name",modelDocumentation:e.modelDocumentation||""}}async function he(e,n=1,o=R(),a){try{const t=await B;if(!t)throw new Error("KÃ¹zu DB not ready.");const i=`
      MATCH p = (:Element {id: '${(e||"").replace(/'/g,"\\'")}'})-[:Relationship*1..${n}]-(:Element)
      RETURN collect(p) AS paths;
    `;console.log("Select Node Neighborhood:",i);const c=await t.query(i);if(!(c!=null&&c.getAllObjects)){console.error("Neighborhood query returned invalid result:",c);const g={nodes:[],links:[]};return typeof a=="function"&&a(g),g}const s=await c.getAllObjects(),d=s.length?s[0].paths||[]:[],y=Ae(d),{layers:m=[],relationshipTypes:f=[],elementTypes:A=[]}=o,l=y.links.filter(g=>!f.length||f.includes(g.type)),u={nodes:y.nodes.filter(g=>(!m.length||m.includes(g.layer))&&(!A.length||A.includes(g.type))&&l.some(h=>h.source===g.id||h.target===g.id)),links:l};return typeof a=="function"&&a(u),u}catch(t){return console.error("Error in neighborhood query:",t),alert("Error in neighborhood query: "+t.message),{nodes:[],links:[]}}}function Ae(e=[]){const n=new Map,o=[];return e.forEach(a=>{const t=a._nodes??a._NODES??[],r=a._rels??a._RELS??[];t.forEach(i=>{(i==null?void 0:i.id)!=null&&n.set(i.id,i)});for(let i=0;i<r.length;i++){const c=t[i],s=t[i+1],d=r[i];c&&s&&d&&o.push({source:c.id,target:s.id,type:d.type||"Relationship"})}}),{nodes:Array.from(n.values()),links:o}}async function X(e){try{let p=function(u,g){return typeof g=="bigint"?g.toString():g};const n=await B;if(!n)throw new Error("KÃ¹zu DB not ready.");const o=document.querySelectorAll(".layerCheckbox:checked"),a=o.length?Array.from(o).map(u=>u.value):[],t=a.length?"a.layer IN "+S(a)+" AND b.layer IN "+S(a):"true",r=document.querySelectorAll(".facet-value:not([data-group='relationships']):checked"),i=r.length?Array.from(r).map(u=>u.value):[],c=i.length?"a.type IN "+S(i)+" AND b.type IN "+S(i):"true",s=document.querySelectorAll(".facet-value[data-group='relationships']:checked"),d=s.length?Array.from(s).map(u=>u.value):[],y=d.length?"r.type IN "+S(d):"false",f=`
      MATCH (a:Element)-[r:Relationship]->(b:Element)
      WHERE ${`${t} AND ${c} AND ${y}`}
      RETURN a, r, b
      LIMIT 1000
    `;console.log("Global Filter Query:",f);const A=await n.query(f),l=await Ee(A);sessionStorage.setItem(b,JSON.stringify(l,p)),typeof e=="function"&&e(l)}catch(n){console.error("Error in global filtering:",n),alert("Error in global filtering: "+n.message)}}async function Ee(e){if(!e||typeof e.getAllObjects!="function")return console.error("buildSubgraphFromRecords: queryResult.getAllObjects is not defined"),{nodes:[],links:[]};let n=await e.getAllObjects();(!n||!Array.isArray(n))&&(console.error("buildSubgraphFromRecords: rows is not an array",n),n=[]);const o=new Map,a=[];return n.forEach(t=>{const r=t.a||t.A,i=t.b||t.B,c=t.r||t.R;r&&r.id&&o.set(r.id,r),i&&i.id&&o.set(i.id,i),r&&i&&c&&c.type&&a.push({source:r.id,target:i.id,type:c.type})}),{nodes:Array.from(o.values()),links:a}}const q="/data/ArchiSurance.archimate",Le=!0,Z=e=>{switch(e){case"ApplicationComponent":case"ApplicationCollaboration":case"ApplicationEvent":case"ApplicationFunction":case"ApplicationInteraction":case"ApplicationInterface":case"ApplicationProcess":case"ApplicationService":case"DataObject":return"#b6f4f6";case"BusinessActor":case"BusinessCollaboration":case"BusinessEvent":case"BusinessFunction":case"BusinessInteraction":case"BusinessInterface":case"BusinessObject":case"BusinessProcess":case"BusinessRole":case"BusinessService":case"Contract":case"Product":case"Representation":case"Location":return"#ffffb1";case"Assessment":case"Constraint":case"Driver":case"Goal":case"Meaning":case"Outcome":case"Principle":case"Requirement":case"Stakeholder":case"Value":return"#ccf";case"DistributionNetwork":case"Equipment":case"Facility":case"Material":return"#d1f6c5";case"Artifact":case"CommunicationNetwork":case"Device":case"Node":case"Path":case"SystemSoftware":case"TechnologyCollaboration":case"TechnologyEvent":case"TechnologyFunction":case"TechnologyInteraction":case"TechnologyInterface":case"TechnologyProcess":case"TechnologyService":return"#d1f6c5";case"Capability":case"CourseOfAction":case"Resource":case"ValueStream":return"#f5deaa";case"Deliverable":case"Gap":case"ImplementationEvent":case"Plateau":case"WorkPackage":return"#ffe0e0"}return"#fefefe"},Se=e=>{switch(e){case"ApplicationComponent":return"m -5 1 l 4 0 l 0 2 l -4 0 z m 0 -4 l 4 0 l 0 2 l -4 0 z m 2 0 l 0 -2 l 8 0 l 0 10 l -8 0 l 0 -2 m 0 -2 l 0 -2";case"Artifact":return"M 4 -1 V 5 H -4 V -5 H 0 L 3.35 -1.5 H 0 V -5";case"Assessment":return"m -3.5 -2 C -3.5 -8 5.5 -8 5.5 -2 C 5.5 4 -3.5 4 -3.5 -2 M -1 2 L -4 7";case"ApplicationCollaboration":case"BusinessCollaboration":case"TechnologyCollaboration":return"m -7 0 A 1 1 0 0 0 2 0 A 1 1 0 0 0 -7 0 M -2 0 A 1 1 0 0 0 7 0 A 1 1 0 0 0 -2 0";case"ApplicationEvent":case"BusinessEvent":case"TechnologyEvent":case"ImplementationEvent":return"m -5 -4 C -2 -3 -2 3 -5 4 H 3 C 6 3 6 -3 3 -4 H -5 M 3 -4";case"ApplicationFunction":case"BusinessFunction":case"TechnologyFunction":return"M -0.35 -5.2 L 4 -1 L 4 5 L 0 2 L -4 5 L -4 -1 L 0.35 -5.2";case"ApplicationInteraction":case"BusinessInteraction":case"TechnologyInteraction":return"m -1 -5 C -6 -4 -6 4 -1 5 Z M 1 -5 V -5 C 6 -4 6 4 1 5 Z";case"ApplicationInterface":case"BusinessInterface":case"TechnologyInterface":return"m -3 0 z c 0 -6 9 -6 9 0 C 6 6 -3 6 -3 0 H -8 z";case"ApplicationProcess":case"BusinessProcess":case"TechnologyProcess":return"m -5 -1.5 H 2 V -4 L 6 0 L 2 4 V 1.5 H -5 z";case"ApplicationService":case"BusinessService":case"TechnologyService":return"m -4 3 z c -4 0 -4 -6 0 -6 H 4 C 8 -3 8 3 4 3 z";case"BusinessActor":return"m 0 -2 A 1 1 0 0 0 0 -6 A 1 1 0 0 0 0 -2 V 3 M -3 6 L 0 3 M 3 6 L 0 3 M -3 0 H 3";case"BusinessRole":case"Stakeholder":return"m -4 -3 C -6 -3 -6 3 -4 3 H 4 C 6 3 6 -3 4 -3 H -4 M 4 -3 c -2 0 -2 6 0 6";case"BusinessObject":case"DataObject":return"m -5 -5 H 5 V 5 V 5 V 5 H -5 Z M -5 -3 H 5";case"Capability":return"m -4.5 4.5 h 9 v -9 h -3 v 9 m 3 -6 h -6 v 6 m 6 -3 h -9 v 3";case"CommunicationNetwork":return"m -4 -3 A 1 1 0 0 0 -1 -3 m 0 0 A 1 1 0 0 0 -4 -3 m 6 0 A 1 1 0 0 0 5 -3 A 1 1 0 0 0 2 -3 H -1 m -4 6 A 1 1 0 0 0 -2 3 A 1 1 0 0 0 -5 3 m 6 0 A 1 1 0 0 0 4 3 A 1 1 0 0 0 1 3 H -2 M -2.5 -1.5 L -3.5 1.5 M 3.5 -1.5 L 2.5 1.5";case"Constraint":return"m -4 -4 H 6 L 4 4 H -6 L -4 -4 M -3 4 L -1 -4";case"Contract":return"m -5 -5 H 5 V 5 V 5 V 5 H -5 Z M -5 -3 H 5 M -5 3 H 5";case"CourseOfAction":return"M -4 -1 A 1 1 0 0 0 6 -1 M 6 -1 A 1 1 0 0 0 -4 -1 M -2 -1 A 1 1 0 0 0 4 -1 A 1 1 0 0 0 -2 -1 M 0 -1 A 1 1 0 0 0 2 -1 A 1 1 0 0 0 0 -1 m 0.5 0 a 0.5 0.5 0 0 0 1 0 a 0.5 0.5 0 0 0 -1 0 m 0.5 0 m -6 3 L -2.5 2.5 L -3 5 Z M -6 5 Q -6 3 -4 3 L -3.5 4 Q -5 4 -5 6 Z";case"Deliverable":return"M -5 2 V -3.5 H 5 V 2 Q 2.5 0 0 2 Q -2.5 4 -5 2 Z";case"Device":return"M -3 2 L -5 5 H 5 L 3 2 H 4 C 5 2 5 2 5 1 V -4 C 5 -5 5 -5 4 -5 h -8 C -5 -5 -5 -5 -5 -4 V 1 C -5 2 -5 2 -4 2 H -3 H 3";case"Driver":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -3 0 A 1 1 0 0 0 3 0 A 1 1 0 0 0 -3 0 M -1 0 A 1 1 0 0 0 1 0 A 1 1 0 0 0 -1 0 M -0.5 0 A 0.5 -0.5 0 0 0 0.5 0 A 0.5 0.5 0 0 0 -0.5 0";case"Gap":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -6.3 1.5 H 6.3 M -6.3 -1.5 H 6.3";case"Goal":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -3 0 A 1 1 0 0 0 3 0 A 1 1 0 0 0 -3 0 M -1 0 A 1 1 0 0 0 1 0 A 1 1 0 0 0 -1 0";case"Location":return"m 4 -1 C 6 -8 -6 -8 -4 -1 L 0 6 Z";case"Meaning":return"M -5 0 C -7 -1 -3 -5 -2 -3 C 0 -5 3 -4 2 -2 C 4 -3 6 -2 5 0 C 7 1 5 4 2 3 C 3 5 -3 5 -3 3 C -5 4 -6 2 -5 0 Z";case"Node":return"m -5 -3 V 5 h 8 v -8.5 h -7.32 l 2 -2 H 5 V 2 L 3.1 5.23 M 3 -3 L 5 -5";case"Outcome":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0 M -3 0 A 1 1 0 0 0 3 0 A 1 1 0 0 0 -3 0 M -1 0 A 1 1 0 0 0 1 0 A 1 1 0 0 0 -1 0 M -0.5 0 A 0.5 -0.5 0 0 0 0.5 0 A 0.5 0.5 0 0 0 -0.5 0 M 0 0 L 5.7 -5.7 M 4.5 -7 L 4.2 -4.2 L 7 -4.5";case"Path":return"m -3 4 L -6 0 L -3 -4 M 3 -4 L 6 0 L 3 4 M -3.2 -0.2 H -2.8 V 0.2 H -3.2 Z M -0.2 -0.2 H 0.2 V 0.2 H -0.2 Z M 2.8 -0.2 H 3.2 V 0.2 H 2.8 Z";case"Plateau":return"M -5 0 H 5 M -6 2.4 H 4 M -4 -2.4 H 6";case"Principle":return"M -5 -5 Q -5 -6 -4 -6 Q 0 -6 4 -6 Q 5 -6 5 -5 V 5 Q 5 6 4 6 H -4 Q -5 6 -5 5 Z M -0.35 1.5 V -4 H 0.35 V 1.5 Z M -0.35 3.35 V 4 H 0.35 V 3.35 Z";case"Product":return"m -5 -5 H 5 V 5 V 5 V 5 H -5 Z M -5 -3 H 0 V -5";case"Representation":return"m -5 -5 H 5 v 9 v 0 v 0 c -5 -3 -5 3 -10 0 Z M -5 -3 H 5";case"Requirement":return"m -4 -4 H 6 L 4 4 H -6 Z";case"Resource":return"M -6 -3 Q -6 -4 -5 -4 H 4 Q 5 -4 5 -3 V 3 Q 5 4 4 4 H -5 Q -6 4 -6 3 z m 11 5 A 1 1 0 0 0 6 1 V -1 A 1 1 0 0 0 5 -2 Z M -4 -2 H -4 V 2 M -2 -2 V 2 M 0 -2 V 2";case"SystemSoftware":return"m -6 1 Z c 0 -7 10 -7 10 0 c 0 7 -10 7 -10 0 z m 1 -3.3 c 4 -8.7 15 -1.7 8 6.6";case"Value":return"m -6 0 C -6 -6 6 -6 6 0 C 6 6 -6 6 -6 0";case"ValueStream":return"M 6 0 L 3 4 H -5 L -2 0 L -5 -4 H 3 Z";case"WorkPackage":return"M 3 2 V 0.5 L 5.2 2 L 3 3.5 V 2 H 3.4 V 1.4 L 4.2 2 L 3.4 2.6 V 2 M 3 2 H -2 A 3.4 3.4 0 1 1 0.4 1";case"AndJunction":case"OrJunction":return"M -5 0 A 1 1 0 0 0 5 0 M 5 0 A 1 1 0 0 0 -5 0"}return""},we=(e,n,o,a,t)=>{const i=o.append("g").attr("id","nodes").selectAll("g").data(a).enter().append("g").attr("id",s=>s.id).attr("class",s=>"element-"+s.type.toLowerCase()).classed("node-root",s=>t!==null&&s.id===t?(s.fx=e/2,s.fy=n*.9/2,!0):!1);return i.append("circle").attr("r",10).attr("fill",s=>Z(s.type)).append("title").text(s=>{let d=s.name;return s.documentation!==void 0&&s.documentation.length>0&&(d+=" - "+s.documentation),d}),i.append("path").attr("d",s=>Se(s.type)).attr("class","node-icon"),i.append("text").attr("class","node-label-type").attr("dx",s=>16).attr("dy",s=>-2).text(s=>"("+s.type+")"),i.append("text").attr("class","node-label-name").attr("dx",s=>16).attr("dy",s=>8).text(s=>s.name),i},Me={colorForNodeType:Z},P=e=>{const n=e.append("defs"),o=10,a=10;n.append("marker").attr("id","relationship-arrow-open").attr("viewBox",[0,-8,20,20]).attr("refX",31).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",o).attr("markerHeight",a).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("class","relationship-arrow-open"),n.append("marker").attr("id","relationship-arrow-open-read").attr("viewBox",[0,-8,20,20]).attr("refX",-21).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",o).attr("markerHeight",a).attr("orient","auto").append("path").attr("d","M10,-5L0,0L10,5").attr("class","relationship-arrow-open"),n.append("marker").attr("id","relationship-arrow-closed").attr("viewBox",[0,-8,20,20]).attr("refX",31).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",o).attr("markerHeight",a).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("class","relationship-arrow-closed"),n.append("marker").attr("id","relationship-arrowlarge-open").attr("viewBox",[0,-8,20,20]).attr("refX",31).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",o).attr("markerHeight",a).attr("orient","auto").append("path").attr("d","M 0 0 L 0 -8 L 10 0 L 0 8 L 0 0").attr("class","relationship-arrowlarge-open"),n.append("marker").attr("id","relationship-diamond-open-start").attr("viewBox",[0,-8,22,22]).attr("refX",-23).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",o).attr("markerHeight",a).attr("orient","auto").append("path").attr("d","M 0 0 L 8 -6 L 16 0 L 8 6 L 0 0").attr("class","relationship-diamond-open"),n.append("marker").attr("id","relationship-diamond-closed-start").attr("viewBox",[0,-8,22,22]).attr("refX",-23).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",o).attr("markerHeight",a).attr("orient","auto").append("path").attr("d","M 0 0 L 8 -6 L 16 0 L 8 6 L 0 0").attr("class","relationship-diamond-closed"),n.append("marker").attr("id","relationship-circle-closed-start").attr("viewBox",[0,-8,22,22]).attr("refX",-23).attr("refY",0).attr("markerUnits","userSpaceOnUse").attr("markerWidth",o).attr("markerHeight",a).attr("orient","auto").append("path").attr("d","M 5, 0 m -5, 0 a 5,5 0 1,0 10,0 a 5,5 0 1,0 -10,0").attr("class","relationship-circle-closed")},be=(e,n)=>{const o=e.append("g").attr("id","links").selectAll("line").data(n).enter().append("line").attr("id",a=>a.id).attr("class",a=>"relationship-"+a.type.toLowerCase()).attr("marker-start",a=>ve(a)).attr("marker-end",a=>ke(a)).attr("stroke","#666").attr("stroke-width",1);return o.append("title").text(a=>a.name),o},ve=e=>{switch(e.type){case"Access":return e.accessType==="Read"||e.accessType==="ReadWrite"?"url(#relationship-arrow-open-read)":null;case"Aggregation":return"url(#relationship-diamond-open-start)";case"Composition":return"url(#relationship-diamond-closed-start)";case"Assignment":return"url(#relationship-circle-closed-start)"}},ke=e=>{switch(e.type){case"Triggering":case"Assignment":case"Flow":return"url(#relationship-arrow-closed)";case"Influence":case"Serving":return"url(#relationship-arrow-open)";case"Access":return e.accessType==="Write"||e.accessType==="ReadWrite"?"url(#relationship-arrow-open)":null;case"Realization":case"Specialization":return"url(#relationship-arrowlarge-open)"}};function L(e){return typeof e=="object"&&e.id?e.id:e}function Ce(e,n,o,a){const t=n.filter(r=>{const i=L(r.source),c=L(r.target);return e.some(s=>s.id===i)&&e.some(s=>s.id===c)});Y(e).force("link",_(t).id(r=>r.id).distance(100).strength(1)).force("charge",ee().strength(-300)).force("center",te(o/2,a/2)).stop().tick(300)}function J(e,n,o,a,t){Q("#graph-viewer").remove();const r=a.clientWidth,i=a.clientHeight,c=k(a).append("svg").attr("id","graph-viewer").attr("width",r).attr("height",i);Ce(e,o,r,i),P&&P(c);const s=c.append("g").attr("id","viewer"),d=o.filter(l=>e.some(p=>p.id===L(l.source))&&e.some(p=>p.id===L(l.target))),y=be(s,d).attr("stroke-opacity",.6),m=(l,p)=>{const u=L(l),g=e.find(h=>h.id===u);return g?g[p]:0};y.attr("x1",l=>m(l.source,"x")).attr("y1",l=>m(l.source,"y")).attr("x2",l=>m(l.target,"x")).attr("y2",l=>m(l.target,"y"));const f=we(r,i,s,e,n).attr("transform",l=>`translate(${l.x},${l.y})`);f.classed("pinned-node",l=>l.id===n).select("text").classed("pinned-node",l=>l.id===n),f.on("dblclick",function(l,p){l.stopPropagation();const u=+document.getElementById("depthInput").value||1,g=R();document.getElementById("loading-message").style.display="block",he(p.id,u,g,h=>{document.getElementById("loading-message").style.display="none",J(h.nodes,p.id,h.links,a)})});const A=K().on("start",function(l,p){k(this).classed("dragging-node",!0)}).on("drag",function(l,p){p.x=l.x,p.y=l.y,k(this).attr("transform",`translate(${p.x},${p.y})`),y.filter(u=>L(u.source)===p.id||L(u.target)===p.id).attr("x1",u=>m(u.source,"x")).attr("y1",u=>m(u.source,"y")).attr("x2",u=>m(u.target,"x")).attr("y2",u=>m(u.target,"y"))}).on("end",function(l,p){k(this).classed("dragging-node",!1)});if(f.call(A),c.call(W().on("zoom",l=>s.attr("transform",l.transform))).on("dblclick.zoom",null),c.insert("rect",":first-child").attr("width",r).attr("height",i).attr("fill","transparent").on("click",()=>{f.classed("pinned-node",!1).select("text").classed("pinned-node",!1)}),!e.length)c.attr("viewBox",`0 0 ${r} ${i}`);else{let l=1e9,p=1e9,u=-1e9,g=-1e9;e.forEach(v=>{l=Math.min(l,v.x),p=Math.min(p,v.y),u=Math.max(u,v.x),g=Math.max(g,v.y)});const h=20;c.attr("viewBox",`${l-h} ${p-h} ${u-l+2*h} ${g-p+2*h}`)}}const H="archiGraphUserSettings";let F={userLoadedModel:!1,userLoadedModelFilename:"",stickyNodesOnDrag_Enabled:!0};const Te=e=>{localStorage.setItem(H,JSON.stringify(e))},x=()=>{let e=F;return localStorage.getItem(H)&&(e=JSON.parse(localStorage.getItem(H))),e},$=e=>{let n=x();return!(e in n)&&e in F&&(E(e,F[e]),n=x()),n[e]},E=(e,n)=>{let o=x();o[e]=n,Te(o)},xe=()=>{const e=x();if(e.userLoadedModel){const n=document.getElementById("userModelLoad-dragDrop-message");n.innerText=`Current loaded model: ${e.userLoadedModelFilename}`,document.getElementById("userModelLoad-delete").classList.remove("hidden")}document.getElementById("stickyNodesOnDrag").checked=$("stickyNodesOnDrag_Enabled"),document.getElementById("dialog-userSettings").showModal()},Be=()=>{document.getElementById("dialog-userSettings").close(),document.getElementById("userModelLoad-dragDrop-message").innerText=""},Ie=(e,n)=>{var i;const o=((i=e.dataTransfer)==null?void 0:i.files)||e.target.files;if(!o||o.length===0){alert("No files were detected. Please try again.");return}const a=o[0];if(![".xml",".archimate"].some(c=>a.name.endsWith(c))){alert("Oops, it must be an .xml or .archimate file! Please ensure it is an ArchiMate Exchange Format or Archi file.");return}const t=document.getElementById("userModelLoad-dragDrop-message");t.innerText=`Loading: ${a.name}`;const r=new FileReader;r.onload=()=>{U(r.result,()=>{E("userLoadedModel",!0),E("userLoadedModelFilename",a.name),document.getElementById("userModelLoad-delete").classList.remove("hidden"),t.innerText=`The ${a.name} file has been loaded.`,typeof n=="function"&&n()})},r.readAsText(a)},Ne=()=>{const e=$("userLoadedModelFilename");ye();const n=document.getElementById("userModelLoad-dragDrop-message");n.innerText=`${e} has been deleted, the default model has been loaded`,E("userLoadedModel",!1),E("userLoadedModelFilename",""),document.getElementById("userModelLoad-delete").classList.add("hidden")};function De(){const n=[{id:"group-business",layer:"Business"},{id:"group-application",layer:"Application"},{id:"group-techinterface",layer:"Technology"},{id:"group-physical",layer:"Technology"}].filter(t=>{var r;return(r=document.getElementById(t.id))==null?void 0:r.checked}).map(t=>t.layer);n.length||n.push("Business","Application","Technology");const o=Array.from(document.querySelectorAll(".facet-value:not([data-group='relationships']):checked")).map(t=>t.value),a=Array.from(document.querySelectorAll(".facet-value[data-group='relationships']:checked")).map(t=>t.value);return{layers:n,elementTypes:o,relationshipTypes:a}}function D(e=!1){const n=De();ue(n),e&&X(()=>{const o=new Event("kuzuFiltersDone");document.dispatchEvent(o)})}function He(){var e;(e=document.getElementById("applyFiltersBtn"))==null||e.addEventListener("click",()=>D(!0)),document.addEventListener("change",n=>{(n.target.matches(".facet-value")||n.target.id.startsWith("group-"))&&D(!1)}),D(!1)}const{colorForNodeType:Fe}=Me;function w(e){return e.replace(/[<>&'"]/g,function(n){switch(n){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case"'":return"&apos;";case'"':return"&quot;"}})}function Re(e,n){const o={Capability:1,CourseOfAction:1,Resource:1,ValueStream:1,BusinessActor:2,BusinessCollaboration:2,BusinessEvent:2,BusinessFunction:2,BusinessInteraction:2,BusinessInterface:2,BusinessObject:2,BusinessProcess:2,BusinessRole:2,BusinessService:2,Contract:2,Product:2,Representation:2,ApplicationComponent:3,ApplicationCollaboration:3,ApplicationEvent:3,ApplicationFunction:3,ApplicationInteraction:3,ApplicationInterface:3,ApplicationProcess:3,ApplicationService:3,DataObject:3,Artifact:4,CommunicationNetwork:4,Device:4,Node:4,Path:4,SystemSoftware:4,TechnologyCollaboration:4,TechnologyEvent:4,TechnologyFunction:4,TechnologyInteraction:4,TechnologyInterface:4,TechnologyProcess:4,TechnologyService:4,"Distribution Network":5,Equipment:5,Facility:5,Material:5},a={};e.forEach(r=>{a[r.id]=r.type});let t=`<?xml version="1.0" encoding="utf-8"?>
`;return t+=`<graphml xmlns="http://graphml.graphdrawing.org/xmlns"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:y="http://www.yworks.com/xml/graphml"
    xsi:schemaLocation="http://graphml.graphdrawing.org/xmlns
      http://www.yworks.com/xml/schema/graphml/1.0/ygraphml.xsd">
`,t+=`  <key for="node" id="d0" yfiles.type="nodegraphics"/>
`,t+=`  <key attr.name="description" attr.type="string" for="node" id="d1"/>
`,t+=`  <key for="edge" id="d2" yfiles.type="edgegraphics"/>
`,t+=`  <key attr.name="description" attr.type="string" for="edge" id="d3"/>
`,t+=`  <graph id="G" edgedefault="directed">
`,e.forEach(r=>{const i=w(r.id),c=(r.name||"")+(r.type?` (${r.type})`:""),s=Fe(r.type),d=r.x!==void 0?parseFloat(r.x):0,y=r.y!==void 0?parseFloat(r.y):0,m=100,f=40;t+=`    <node id="${i}">
`,t+=`      <data key="d0">
`,t+=`        <y:ShapeNode>
`,t+=`          <y:Geometry x="${d}" y="${y}" width="${m}" height="${f}"/>
`,t+=`          <y:Fill color="${s}" transparent="false"/>
`,t+=`          <y:BorderStyle color="#000000" type="line" width="1.0"/>
`,t+=`          <y:NodeLabel alignment="center" autoSizePolicy="node_width" fontFamily="Dialog" fontSize="5" fontStyle="plain" textColor="#000000" visible="true" modelName="internal" modelPosition="c">
`,t+=`            ${w(c)}
`,t+=`          </y:NodeLabel>
`,t+=`          <y:Shape type="rectangle"/>
`,t+=`        </y:ShapeNode>
`,t+=`      </data>
`,t+=`    </node>
`}),n.forEach((r,i)=>{let c=typeof r.source=="object"?r.source.id:r.source,s=typeof r.target=="object"?r.target.id:r.target;const d=a[c],y=a[s];o[d]&&o[y]?o[d]>o[y]&&([c,s]=[s,c]):(r.type==="Realization"||r.type==="Serving")&&([c,s]=[s,c]);const m=`e${i}`;t+=`    <edge id="${w(m)}" source="${w(c)}" target="${w(s)}">
`,t+=`      <data key="d2">
`,t+=`        <y:PolyLineEdge>
`,t+=`          <y:LineStyle color="#000000" type="line" width="1.0"/>
`,t+=`          <y:Arrows source="none" target="standard"/>
`,t+=`          <y:BendStyle smoothed="true"/>
`,t+=`        </y:PolyLineEdge>
`,t+=`      </data>
`,t+=`    </edge>
`}),t+=`  </graph>
`,t+=`</graphml>
`,t}function Oe(e,n){const o=new Blob([e],{type:"application/xml"}),a=URL.createObjectURL(o),t=document.createElement("a");t.href=a,t.download=n,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(a)}function qe(){const e=sessionStorage.getItem("archiGraphDataStore");if(!e){alert("No graph data found in session storage.");return}const n=JSON.parse(e);let o=Array.isArray(n.nodes)?n.nodes:Object.values(n.nodes||{});const a=n.links||[],t={};o.forEach(c=>{t[c.id]=c}),a.forEach(c=>{const s=typeof c.source=="object"?c.source.id:c.source,d=typeof c.target=="object"?c.target.id:c.target;t[s]||(t[s]={id:s,name:s,type:"Undefined",x:0,y:0}),t[d]||(t[d]={id:d,name:d,type:"Undefined",x:0,y:0})}),o=Object.values(t);const r=Re(o,a),i=(n.modelName||"graph")+".graphml";Oe(r,i)}typeof document<"u"&&document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("exportGraphMLButton");e&&e.addEventListener("click",qe)});let $e=typeof window<"u"?new URLSearchParams(window.location.search):new URLSearchParams;function I(){const e=G();document.getElementById("loading-message").style.display="none",J(e.nodes,null,e.links,document.getElementById("graph-container"))}function M(){I()}function Ve(){const e=document.querySelector("header");($e.get("showheader")==="true"||Le)&&(e.style.display="block"),document.getElementById("action-userSettings").classList.remove("hidden"),document.getElementById("userSettings-userModelLoad").classList.remove("hidden")}function Pe(e,n){let o;return(...a)=>{clearTimeout(o),o=setTimeout(()=>e(...a),n)}}document.getElementById("action-reload").addEventListener("click",()=>O(q,M));document.getElementById("action-model-overview").addEventListener("click",()=>{const e=fe();document.getElementById("model-name").innerText=e.modelName,document.getElementById("model-documentation").innerText=e.modelDocumentation,document.getElementById("dialog-overview").showModal()});["dialog-overview-close","dialog-overview-close-x"].forEach(e=>document.getElementById(e).addEventListener("click",()=>document.getElementById("dialog-overview").close()));document.getElementById("action-userSettings").addEventListener("click",()=>xe());["dialog-userSettings-close","dialog-userSettings-close-x"].forEach(e=>document.getElementById(e).addEventListener("click",()=>Be()));const j=document.getElementById("userModelLoad-dragDrop-zone");j.addEventListener("dragover",e=>e.preventDefault());j.addEventListener("drop",e=>{e.preventDefault(),Ie(e,M)});document.getElementById("userModelLoad-delete").addEventListener("click",()=>{Ne(),O(q,M)});document.getElementById("stickyNodesOnDrag").addEventListener("change",function(){E("stickyNodesOnDrag_Enabled",this.checked)});He();document.getElementById("applyFiltersBtn").addEventListener("click",async()=>{document.getElementById("loading-message").style.display="block",await X(()=>{document.getElementById("loading-message").style.display="none";const e=new Event("kuzuFiltersDone");document.dispatchEvent(e)})});pe(()=>{});window.onload=async()=>{Ve(),ge()||(E("userLoadedModel",!1),E("userLoadedModelFilename","")),$("userLoadedModel")?M():await O(q,M)};window.onresize=Pe(I,100);window.onpopstate=()=>I();document.addEventListener("kuzuFiltersDone",()=>{console.log("Global filter applied â†’ reâ€‘draw from session"),I()});
